<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha T√©cnica de Prepara√ß√£o Alimentar</title>
    <link rel="stylesheet" href="/css/criarFichaTecnica.css">
    <link rel="stylesheet" href="/css/navbar.css">
</head>
<body>

<header class="header">
    <div class="logo-container">
        <img src="/images/logo.png" alt="Logo Nutri√ß√£o" class="logo">
        <h1>Fichas T√©cnicas de Nutri√ß√£o</h1>
    </div>
    <button type="button" class="navbar-btn" onclick="window.location.href='/dashboard'">Voltar</button>

</header>

<div class="container">
    <span class="titulo-ficha">Ficha T√©cnica</span>
    <form id="fichaTecnicaForm">
        <section class="section">
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome-preparacao">Nome da prepara√ß√£o:</label>
                        <input type="text" id="nome-preparacao" name="nome-preparacao" required>
                    </div>
                    <div class="form-group medium">
                        <label for="categoria">Categoria:</label>
                        <select id="categoria" name="categoria" required>
                            <option value="" disabled selected>Selecione uma categoria</option>
                            <option value="ENTRADA">Entrada</option>
                            <option value="PRATO_PRINCIPAL">Prato Principal</option>
                            <option value="GUARNICAO">Guarni√ß√£o</option>
                            <option value="SALADA">Salada</option>
                            <option value="SOBREMESA">Sobremesa</option>
                            <option value="BEBIDA">Bebida</option>
                        </select>
                    </div>
                    <div class="form-group small">
                        <label for="numero">N¬∫:</label>
                        <input type="number" id="numero" name="numero">
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">ü•¨ Ingredientes</h2>
            <div class="section-content">
                <div class="table-container">
                    <table id="ingredientes-table">
                        <thead>
                        <tr>
                            <th>Ingredientes</th>
                            <th>Medida caseira</th>
                            <th>PB (g)</th>
                            <th>PL (g)</th>
                            <th>FC</th>
                            <th>Custo (forma de compra)</th>
                            <th>Custo (quantidade utilizada)</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input type="text" class="ingrediente-nome" placeholder="Ingrediente"></td>
                            <td><input type="text" class="medida-caseira-ingrediente" placeholder="Medida"></td>
                            <td><input type="number" step="0.01" class="pb-ingrediente" placeholder="0.00"></td>
                            <td><input type="number" step="0.01" class="pl-ingrediente" placeholder="0.00"></td>
                            <td><input type="number" step="0.01" class="fc-ingrediente" placeholder="0.00" readonly></td>
                            <td><input type="number" step="0.01" class="custo-compra-ingrediente" placeholder="R$ 0,00"></td>
                            <td><input type="number" step="0.01" class="custo-utilizado-ingrediente" placeholder="R$ 0,00" readonly></td>
                            <td><button type="button" class="btn-remover" onclick="removerLinha(this)">Remover</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-icon" onclick="adicionarIngrediente()">
                    Adicionar Ingrediente
                </button>

                <div class="water-calc">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="agua-fcc">Quantidade de √°gua (C√°lculo de FCC):</label>
                            <select id="agua-fcc" name="agua-fcc">
                                <option value="opcao1">25%</option>
                                <option value="opcao2">50%</option>
                                <option value="opcao3">75%</option>
                                <option value="opcao3">100%</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üìù Modo de preparo e Equipamentos</h2>
            <div class="section-content">
                <div class="two-column">
                    <div class="form-group">
                        <label for="modo-preparo">Modo de preparo:</label>
                        <textarea id="modo-preparo" name="modo-preparo" placeholder="Descreva o modo de preparo..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="equipamentos">Equipamentos e utens√≠lios utilizados:</label>
                        <textarea id="equipamentos" name="equipamentos" placeholder="Liste os equipamentos e utens√≠lios..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üìä Informa√ß√µes Complementares</h2>
            <div class="section-content">
                <div class="grid-4">
                    <div class="form-group">
                        <label for="custo-total">Custo total:</label>
                        <input type="number" step="0.01" id="custo-total" name="custo-total" placeholder="R$ 0,00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="custo-per-capita">Custo per capita:</label>
                        <input type="number" step="0.01" id="custo-per-capita" name="custo-per-capita" placeholder="R$ 0,00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="tempo-preparo">Tempo de preparo (minutos):</label>
                        <input type="number" id="tempo-preparo" name="tempo-preparo" placeholder="00">
                    </div>
                    <div class="form-group">
                        <label for="medida-caseira">Medida caseira final:</label>
                        <input type="text" id="medida-caseira" name="medida-caseira">
                    </div>
                    <div class="form-group">
                        <label for="rendimento">Rendimento (g ou ml):</label>
                        <input type="number" step="0.01" id="rendimento" name="rendimento" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="peso-porcao">Peso da por√ß√£o (g):</label>
                        <input type="number" step="0.01" id="peso-porcao" name="peso-porcao" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="numero-porcoes">N√∫mero de por√ß√µes:</label>
                        <input type="number" id="numero-porcoes" name="numero-porcoes">
                    </div>
                    <div class="form-group">
                        <label for="fcc">Fcc Geral:</label>
                        <input type="number" step="0.01" id="fcc" name="fcc" placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üçé Perfil Nutricional</h2>
            <div class="section-content">
                <div class="table-container">
                    <table id="nutricional-table">
                        <thead>
                        <tr>
                            <th>Ingredientes</th>
                            <th>Per capita (PL)</th>
                            <th>PTN</th>
                            <th>CHO</th>
                            <th>LIP</th>
                            <th>S√≥dio</th>
                            <th>Gordura Saturada</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-icon" onclick="adicionarNutriente()">
                    Adicionar Nutriente (Apenas para demonstra√ß√£o, idealmente preenchido pelos ingredientes)
                </button>

                <div class="nutrition-extras">
                    <div class="form-group">
                        <label for="total-macros-g">Total dos Macros (g):</label>
                        <input type="number" step="0.01" id="total-macros-g" name="total-macros-g" placeholder="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-macros-kcal">Total dos Macros (Kcal):</label>
                        <input type="number" step="0.01" id="total-macros-kcal" name="total-macros-kcal" placeholder="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-macros-percent">Total dos Macros (%):</label>
                        <input type="text" id="total-macros-percent" name="total-macros-percent" placeholder="0.00%" readonly>
                    </div>
                    <div class="form-group">
                        <label for="vct">VCT (Kcal):</label>
                        <input type="number" step="0.01" id="vct" name="vct" placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </section>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar Ficha T√©cnica</button>
        </div>
    </form>
</div>

<script>
    // Fun√ß√£o para buscar ingredientes do backend para autocomplete
    async function buscarIngredientes(query) {
        try {
            const response = await fetch(`/api/ingredientes/buscar?nome=${encodeURIComponent(query)}`, {
                credentials: 'include' // IMPORTANTE: Inclui o cookie JSESSIONID na requisi√ß√£o
            });

            if (response.ok) {
                return await response.json();
            } else if (response.status === 401 || response.status === 403) {
                // Se a sess√£o expirou ou n√£o est√° autorizada, redireciona para o login
                alert('Sua sess√£o expirou ou voc√™ n√£o est√° autorizado. Fa√ßa login novamente.');
                window.location.href = '/login';
                return []; // Retorna lista vazia para evitar erros
            } else {
                console.error('Erro ao buscar ingredientes:', response.statusText);
                return [];
            }
        } catch (error) {
            console.error('Erro na requisi√ß√£o de buscar ingredientes:', error);
            alert('Ocorreu um erro na comunica√ß√£o com o servidor ao buscar ingredientes.');
            return [];
        }
    }

    // Fun√ß√£o para adicionar uma nova linha na tabela de ingredientes
    function adicionarIngrediente() {
        const tableBody = document.querySelector('#ingredientes-table tbody');
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="ingrediente-nome" placeholder="Ingrediente"></td>
            <td><input type="text" class="medida-caseira-ingrediente" placeholder="Medida"></td>
            <td><input type="number" step="0.01" class="pb-ingrediente" placeholder="0.00"></td>
            <td><input type="number" step="0.01" class="pl-ingrediente" placeholder="0.00"></td>
            <td><input type="number" step="0.01" class="fc-ingrediente" placeholder="0.00" readonly></td>
            <td><input type="number" step="0.01" class="custo-compra-ingrediente" placeholder="R$ 0,00"></td>
            <td><input type="number" step="0.01" class="custo-utilizado-ingrediente" placeholder="R$ 0,00" readonly></td>
            <td><button type="button" class="btn-remover" onclick="removerLinha(this)">Remover</button></td>
        `;
        setupAutocompleteForElement(newRow.querySelector('.ingrediente-nome'));

        // Adiciona event listeners para os novos campos da linha
        const pbInput = newRow.querySelector('.pb-ingrediente');
        const plInput = newRow.querySelector('.pl-ingrediente');
        const custoCompraInput = newRow.querySelector('.custo-compra-ingrediente');

        // Chame a fun√ß√£o de c√°lculo sempre que esses inputs mudarem
        pbInput.addEventListener('input', atualizarCalculosIngrediente);
        plInput.addEventListener('input', atualizarCalculosIngrediente);
        custoCompraInput.addEventListener('input', atualizarCalculosIngrediente);

        // Tamb√©m recalcule tudo ap√≥s adicionar uma nova linha
        atualizarCalculosGlobais();
    }

    // Fun√ß√£o para adicionar uma nova linha na tabela nutricional (exemplo)
    // OBS: Esta fun√ß√£o √© mais um placeholder, o ideal √© que a tabela nutricional seja preenchida automaticamente.
    function adicionarNutriente() {
        const tableBody = document.querySelector('#nutricional-table tbody');
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" placeholder="Ingrediente"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><button type="button" class="btn-remover" onclick="removerLinha(this)">Remover</button></td>
        `;
    }

    // Fun√ß√£o para remover uma linha da tabela
    function removerLinha(button) {
        const row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
        atualizarCalculosGlobais(); // Recalcular tudo ap√≥s remover uma linha
    }

    // Fun√ß√£o para autocomplete no campo de ingrediente
    async function setupAutocompleteForElement(inputElement) {
        let timeout = null; // Para debounce
        inputElement.addEventListener('input', async function(e) {
            clearTimeout(timeout); // Limpa o timeout anterior
            const query = e.target.value;

            // Limpa o ID do ingrediente quando o usu√°rio digita novamente
            e.target.dataset.ingredienteId = ''; // Limpa o ID do input
            // Limpa dados nutricionais associados √† linha se o ingrediente mudar
            const currentRow = e.target.closest('tr');
            if (currentRow) {
                currentRow.dataset.proteina = '';
                currentRow.dataset.carboidrato = '';
                currentRow.dataset.lipidio = '';
                currentRow.dataset.sodio = '';
                currentRow.dataset.gorduraSaturada = '';
                currentRow.dataset.kcal = ''; // Se voc√™ tiver calorias por 100g no Ingrediente
            }

            let old = inputElement.parentNode.querySelector('.autocomplete-list');
            if (old) old.remove();

            if (query.length < 2) return; // N√£o busca se a query for muito curta

            timeout = setTimeout(async () => { // Debounce para evitar muitas chamadas √† API
                const lista = await buscarIngredientes(query);

                if (lista.length > 0) {
                    let dropdown = document.createElement('div');
                    dropdown.className = 'autocomplete-list';
                    dropdown.style.position = 'absolute';
                    dropdown.style.background = '#fff';
                    dropdown.style.border = '1px solid #ccc';
                    dropdown.style.zIndex = 1000;
                    dropdown.style.maxHeight = '200px'; // Limita a altura do dropdown
                    dropdown.style.overflowY = 'auto'; // Adiciona scroll se necess√°rio
                    dropdown.style.width = inputElement.offsetWidth + 'px'; // Mesma largura do input

                    lista.forEach(item => {
                        let option = document.createElement('div');
                        option.textContent = item.nome;
                        option.dataset.ingredienteId = item.id;
                        // Armazena todos os dados nutricionais no dataset do option
                        option.dataset.proteina = item.proteina;
                        option.dataset.carboidrato = item.carboidrato;
                        option.dataset.lipidio = item.lipidio;
                        option.dataset.sodio = item.sodio;
                        option.dataset.gorduraSaturada = item.gorduraSaturada;
                        // Certifique-se que o IngredienteDTO tenha o campo `kcal` (ou calcule aqui)
                        option.dataset.kcal = (item.proteina * 4) + (item.carboidrato * 4) + (item.lipidio * 9); // Kcal por 100g

                        option.onclick = () => {
                            e.target.value = item.nome;
                            e.target.dataset.ingredienteId = item.id; // <--- ESTA LINHA √â CRUCIAL PARA O INPUT

                            const tr = e.target.closest('tr');
                            tr.dataset.ingredienteId = item.id; // <--- ESTA LINHA √â CRUCIAL PARA A LINHA
                            tr.dataset.proteina = item.proteina;
                            tr.dataset.carboidrato = item.carboidrato;
                            tr.dataset.lipidio = item.lipidio;
                            tr.dataset.sodio = item.sodio;
                            tr.dataset.gorduraSaturada = item.gorduraSaturada;
                            tr.dataset.kcal = option.dataset.kcal;

                            dropdown.remove();
                            atualizarCalculosGlobais();
                        };
                        dropdown.appendChild(option);
                    });
                    inputElement.parentNode.appendChild(dropdown);
                }
            }, 300); // Debounce de 300ms
        });

        // Remover dropdown ao clicar fora
        inputElement.addEventListener('blur', function() {
            setTimeout(() => { // Pequeno delay para permitir o click no item do dropdown
                let old = inputElement.parentNode.querySelector('.autocomplete-list');
                if (old) old.remove();
            }, 100);
        });
    }

    // Fun√ß√£o que coleta todos os dados do formul√°rio para envio
    function coletarDadosFormulario() {
        const dados = {
            nome: document.getElementById('nome-preparacao').value,
            categoria: document.getElementById('categoria').value,
            modoPreparo: document.getElementById('modo-preparo').value,
            tempoPreparo: parseFloat(document.getElementById('tempo-preparo').value) || 0,
            pesoPorcao: parseFloat(document.getElementById('peso-porcao').value) || 0.0,
            rendimento: parseFloat(document.getElementById('rendimento').value) || 0.0,
            numeroPorcoes: parseInt(document.getElementById('numero-porcoes').value) || 0,
            fcc: parseFloat(document.getElementById('fcc').value) || 0.0, // fcc geral
            medidaCaseira: document.getElementById('medida-caseira').value, // Medida caseira final
            equipamentos: document.getElementById('equipamentos').value,
        };

        // Coletar ingredientes
        const ingredientes = [];
        document.querySelectorAll('#ingredientes-table tbody tr').forEach(row => {
            const ingredienteNomeInput = row.querySelector('.ingrediente-nome');
            const ingredienteId = ingredienteNomeInput.dataset.ingredienteId; // AQUI EST√Å A CHAVE!

            // Validar se o ingredienteId est√° presente e se o nome n√£o est√° vazio
            if (ingredienteId && ingredienteNomeInput.value.trim() !== '') {
                ingredientes.push({
                    ingredienteId: parseInt(ingredienteId), // Converter para n√∫mero inteiro
                    ingredienteNome: ingredienteNomeInput.value.trim(),
                    medidaCaseira: row.querySelector('.medida-caseira-ingrediente').value,
                    pesoBruto: parseFloat(row.querySelector('.pb-ingrediente').value) || 0.0,
                    pesoLiquido: parseFloat(row.querySelector('.pl-ingrediente').value) || 0.0,
                    fatorCorrecao: parseFloat(row.querySelector('.fc-ingrediente').value) || 0.0,
                    custoCompra: parseFloat(row.querySelector('.custo-compra-ingrediente').value) || 0.0,
                    custoUtilizado: parseFloat(row.querySelector('.custo-utilizado-ingrediente').value) || 0.0
                });
            } else {
                console.warn(`Ingrediente ignorado por falta de nome ou ID: ${ingredienteNomeInput.value}, ID: ${ingredienteId}`);
            }
        });
        dados.ingredientes = ingredientes;

        // Coletar perfil nutricional (assumindo que voc√™ preenche isso no JS ou que est√° no DTO)
        const perfilNutricional = {
            perCapita: parseFloat(document.getElementById('peso-porcao').value) || 0.0, // Assumindo que perCapita seja o peso da por√ß√£o
            totalGramas: parseFloat(document.getElementById('total-macros-g').value) || 0.0,
            totalKcal: parseFloat(document.getElementById('total-macros-kcal').value) || 0.0,
            // totalPorcentagem √© string, mas seu DTO espera Double. Adapte se necess√°rio.
            totalPorcentagem: parseFloat(document.getElementById('total-macros-percent').value.replace('%', '')) || 0.0,
            vct: parseFloat(document.getElementById('vct').value) || 0.0
        };

        // S√≥ adicione o perfil se ele tiver dados significativos (para evitar enviar objeto vazio)
        if (perfilNutricional.totalKcal > 0 || perfilNutricional.totalGramas > 0 || perfilNutricional.vct > 0) {
            dados.perfilNutricional = perfilNutricional;
        } else {
            dados.perfilNutricional = null;
        }

        return dados;
    }

    // Fun√ß√£o de envio do formul√°rio
    document.getElementById('fichaTecnicaForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // Impede o envio padr√£o do formul√°rio

        const dadosParaEnviar = coletarDadosFormulario();
        console.log("Dados a serem enviados:", dadosParaEnviar); // Verifique o objeto antes de enviar

        try {
            const response = await fetch('/api/receitas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // REMOVIDO: Nenhuma necessidade de cabe√ßalho 'Authorization' para autentica√ß√£o baseada em sess√£o
                },
                body: JSON.stringify(dadosParaEnviar),
                credentials: 'include' // **CRUCIAL: Isso garante que o cookie JSESSIONID seja enviado**
            });

            if (response.ok) {
                alert('Ficha T√©cnica salva com sucesso!');
                window.location.href = '/visualizar'; // Redirecionar para a p√°gina de receitas
            } else if (response.status === 401 || response.status === 403) {
                // Se o servidor retornar 401 (N√£o Autorizado) ou 403 (Proibido),
                // √© porque a sess√£o expirou ou o usu√°rio n√£o tem permiss√£o.
                alert('Sua sess√£o expirou ou voc√™ n√£o est√° autorizado. Fa√ßa login novamente.');
                window.location.href = '/login'; // Redirecionar para a p√°gina de login
            } else {
                const errorData = await response.json();
                console.error('Erro ao salvar ficha t√©cnica:', errorData);
                alert('Erro ao salvar ficha t√©cnica: ' + (errorData.message || response.statusText));
            }
        } catch (error) {
            console.error('Erro na requisi√ß√£o:', error);
            alert('Ocorreu um erro na comunica√ß√£o com o servidor.');
        }
    });

    // Certifique-se de que todos os inputs de ingrediente existentes ao carregar a p√°gina
    // e os novos adicionados recebam o autocomplete.
    document.querySelectorAll('.ingrediente-nome').forEach(input => {
        setupAutocompleteForElement(input);
    });

    // Event listeners para c√°lculos no frontend
    document.querySelectorAll('.pb-ingrediente, .pl-ingrediente, .custo-compra-ingrediente').forEach(input => {
        input.addEventListener('input', atualizarCalculosIngrediente);
    });

    // Event listener para o n√∫mero de por√ß√µes, afeta o custo per capita
    document.getElementById('numero-porcoes').addEventListener('input', atualizarCalculosGlobais);

    // Fun√ß√£o para atualizar c√°lculos de ingrediente (FC e Custo Utilizado)
    function atualizarCalculosIngrediente(event) {
        const row = event.target.closest('tr');
        const pb = parseFloat(row.querySelector('.pb-ingrediente').value) || 0;
        const pl = parseFloat(row.querySelector('.pl-ingrediente').value) || 0;
        const custoCompra = parseFloat(row.querySelector('.custo-compra-ingrediente').value) || 0;

        // C√°lculo do Fator de Corre√ß√£o (FC)
        const fc = (pb > 0 && pl > 0) ? (pb / pl) : 0;
        row.querySelector('.fc-ingrediente').value = fc.toFixed(2);

        // C√°lculo do Custo Utilizado
        const custoUtilizado = (pb > 0) ? (custoCompra * (pl / pb)) : 0;
        row.querySelector('.custo-utilizado-ingrediente').value = custoUtilizado.toFixed(2);

        atualizarCalculosGlobais(); // Recalcular totais globais
    }

    // Fun√ß√£o para atualizar c√°lculos globais (Custo Total, Custo Per Capita, FCC Geral, Totais Nutricionais)
    function atualizarCalculosGlobais() {
        let custoTotal = 0;
        let totalPesoLiquido = 0;
        let totalPesoBruto = 0;
        let totalProteina = 0;
        let totalCarboidrato = 0;
        let totalLipidio = 0;
        let totalSodio = 0;
        let totalGorduraSaturada = 0;
        let totalKcal = 0;

        document.querySelectorAll('#ingredientes-table tbody tr').forEach(row => {
            const custoUtilizado = parseFloat(row.querySelector('.custo-utilizado-ingrediente').value) || 0;
            const pl = parseFloat(row.querySelector('.pl-ingrediente').value) || 0;
            const pb = parseFloat(row.querySelector('.pb-ingrediente').value) || 0;

            custoTotal += custoUtilizado;
            totalPesoLiquido += pl;
            totalPesoBruto += pb;

            // Coleta dados nutricionais do dataset da linha (preenchido pelo autocomplete)
            const proteina = parseFloat(row.dataset.proteina || 0);
            const carboidrato = parseFloat(row.dataset.carboidrato || 0);
            const lipidio = parseFloat(row.dataset.lipidio || 0);
            const sodio = parseFloat(row.dataset.sodio || 0);
            const gorduraSaturada = parseFloat(row.dataset.gorduraSaturada || 0);
            const kcalPor100g = parseFloat(row.dataset.kcal || 0);

            // Calcula a contribui√ß√£o de cada ingrediente para os totais
            // Assumindo que os valores nutricionais no backend s√£o por 100g
            if (pl > 0) {
                const fatorProporcional = pl / 100;
                totalProteina += proteina * fatorProporcional;
                totalCarboidrato += carboidrato * fatorProporcional;
                totalLipidio += lipidio * fatorProporcional;
                totalSodio += sodio * fatorProporcional;
                totalGorduraSaturada += gorduraSaturada * fatorProporcional;
                totalKcal += kcalPor100g * fatorProporcional;
            }
        });

        // Atualizar Custo Total
        document.getElementById('custo-total').value = custoTotal.toFixed(2);

        // Atualizar Custo Per Capita (se houver n√∫mero de por√ß√µes)
        const numeroPorcoes = parseInt(document.getElementById('numero-porcoes').value) || 1;
        const custoPerCapita = numeroPorcoes > 0 ? (custoTotal / numeroPorcoes) : 0;
        document.getElementById('custo-per-capita').value = custoPerCapita.toFixed(2);

        // Atualizar FCC Geral
        const fccGeral = (totalPesoBruto > 0 && totalPesoLiquido > 0) ? (totalPesoBruto / totalPesoLiquido) : 0;
        document.getElementById('fcc').value = fccGeral.toFixed(2);

        // Atualizar totais nutricionais
        document.getElementById('total-macros-g').value = (totalProteina + totalCarboidrato + totalLipidio).toFixed(2);
        document.getElementById('total-macros-kcal').value = totalKcal.toFixed(2);

        // VCT - Valor Cal√≥rico Total (geralmente √© o total de Kcal)
        document.getElementById('vct').value = totalKcal.toFixed(2);

        // Porcentagens de macros em rela√ß√£o ao VCT (se VCT > 0)
        let totalMacrosPercent = "0.00%";
        if (totalKcal > 0) {
            const percentCHO = (totalCarboidrato * 4 / totalKcal * 100);
            const percentPTN = (totalProteina * 4 / totalKcal * 100);
            const percentLIP = (totalLipidio * 9 / totalKcal * 100);
            totalMacrosPercent = `${(percentPTN + percentCHO + percentLIP).toFixed(2)}%`;
        }
        document.getElementById('total-macros-percent').value = totalMacrosPercent;
    }

    // Chamar para c√°lculos iniciais ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        // Aplica o autocomplete nos inputs de ingrediente j√° existentes ao carregar a p√°gina
        document.querySelectorAll('.ingrediente-nome').forEach(input => {
            setupAutocompleteForElement(input);
        });

        // Adiciona listeners para inputs de c√°lculo existentes
        document.querySelectorAll('.pb-ingrediente, .pl-ingrediente, .custo-compra-ingrediente').forEach(input => {
            input.addEventListener('input', atualizarCalculosIngrediente);
        });

        // Listener para o n√∫mero de por√ß√µes, afeta o custo per capita
        document.getElementById('numero-porcoes').addEventListener('input', atualizarCalculosGlobais);

        atualizarCalculosGlobais(); // Realiza os c√°lculos iniciais
    });
</script>
</body>
</html>