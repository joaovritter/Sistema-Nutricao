<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha T√©cnica de Prepara√ß√£o Alimentar</title>
    <link rel="stylesheet" href="/css/criarFichaTecnica.css">
    <link rel="stylesheet" href="/css/navbar.css">
</head>
<body>

<header class="header">
    <div class="logo-container">
        <img src="/images/logo.png" alt="Logo Nutri√ß√£o" class="logo">
        <h1>Fichas T√©cnicas de Nutri√ß√£o</h1>
    </div>
    <button type="button" class="navbar-btn" onclick="window.location.href='/dashboard'">Voltar</button>

</header>

<div class="container">
    <span class="titulo-ficha">Ficha T√©cnica</span>
    <form id="fichaTecnicaForm">
        <section class="section">
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome-preparacao">Nome da prepara√ß√£o:</label>
                        <input type="text" id="nome-preparacao" name="nome-preparacao" required>
                    </div>
                    <div class="form-group medium">
                        <label for="categoria">Categoria:</label>
                        <select id="categoria" name="categoria" required>
                            <option value="" disabled selected>Selecione uma categoria</option>
                            <option value="ENTRADA">Entrada</option>
                            <option value="PRATO_PRINCIPAL">Prato Principal</option>
                            <option value="GUARNICAO">Guarni√ß√£o</option>
                            <option value="SALADA">Salada</option>
                            <option value="SOBREMESA">Sobremesa</option>
                            <option value="BEBIDA">Bebida</option>
                        </select>
                    </div>
                    <div class="form-group small">
                        <label for="numero">N¬∫:</label>
                        <input type="number" id="numero" name="numero">
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">ü•¨ Ingredientes</h2>
            <div class="section-content">
                <div class="table-container">
                    <table id="ingredientes-table">
                        <thead>
                        <tr>
                            <th>Ingredientes</th>
                            <th>Medida caseira</th>
                            <th>PB (g)</th>
                            <th>PL (g)</th>
                            <th>FC</th>
                            <th>Custo (forma de compra)</th>
                            <th>Custo (quantidade utilizada)</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-icon" onclick="adicionarIngrediente()">
                    Adicionar Ingrediente
                </button>
                <button type="button" class="btn btn-icon" onclick="window.location.href='/criarIngrediente'">
                    Criar Ingrediente
                </button>

                <div class="water-calc">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="agua-fcc">Quantidade de √°gua (C√°lculo de FCC):</label>
                            <select id="agua-fcc" name="agua-fcc">
                                <option value="0.00" selected>Nenhuma (ou padr√£o)</option>
                                <option value="0.25">25%</option>
                                <option value="0.50">50%</option>
                                <option value="0.75">75%</option>
                                <option value="1.00">100%</option>
                                <option value="1.50">150%</option>
                                <option value="2.00">200%</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üìù Modo de preparo e Equipamentos</h2>
            <div class="section-content">
                <div class="two-column">
                    <div class="form-group">
                        <label for="modo-preparo">Modo de preparo:</label>
                        <textarea id="modo-preparo" name="modo-preparo" placeholder="Descreva o modo de preparo..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="equipamentos">Equipamentos e utens√≠lios utilizados:</label>
                        <textarea id="equipamentos" name="equipamentos" placeholder="Liste os equipamentos e utens√≠lios..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üìä Informa√ß√µes Complementares</h2>
            <div class="section-content">
                <div class="grid-4">
                    <div class="form-group">
                        <label for="custo-total">Custo total:</label>
                        <input type="number" step="0.01" id="custo-total" name="custo-total" placeholder="R$ 0,00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="custo-per-capita">Custo per capita:</label>
                        <input type="number" step="0.01" id="custo-per-capita" name="custo-per-capita" placeholder="R$ 0,00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="tempo-preparo">Tempo de preparo (minutos):</label>
                        <input type="number" id="tempo-preparo" name="tempo-preparo" placeholder="00">
                    </div>
                    <div class="form-group">
                        <label for="medida-caseira">Medida caseira final:</label>
                        <input type="text" id="medida-caseira" name="medida-caseira">
                    </div>
                    <div class="form-group">
                        <label for="rendimento">Rendimento (g ou ml):</label>
                        <input type="number" step="0.01" id="rendimento" name="rendimento" placeholder="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="peso-porcao">Peso da por√ß√£o (g):</label>
                        <input type="number" step="0.01" id="peso-porcao" name="peso-porcao" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="numero-porcoes">N√∫mero de por√ß√µes:</label>
                        <input type="number" id="numero-porcoes" name="numero-porcoes">
                    </div>
                    <div class="form-group">
                        <label for="fcc">Fcc Geral:</label>
                        <input type="number" step="0.01" id="fcc" name="fcc" placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">üçé Perfil Nutricional</h2>
            <div class="section-content">
                <div class="table-container">
                    <table id="nutricional-table">
                        <thead>
                        <tr>
                            <th>Ingredientes</th>
                            <th>Per capita (PL)</th>
                            <th>PTN</th>
                            <th>CHO</th>
                            <th>LIP</th>
                            <th>S√≥dio</th>
                            <th>Gordura Saturada</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-icon" onclick="adicionarNutriente()">
                    Adicionar Nutriente (Apenas para demonstra√ß√£o, idealmente preenchido pelos ingredientes)
                </button>

                <div class="nutrition-extras">
                    <div class="form-group">
                        <label for="total-macros-g">Total dos Macros (g):</label>
                        <input type="number" step="0.01" id="total-macros-g" name="total-macros-g" placeholder="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-macros-kcal">Total dos Macros (Kcal):</label>
                        <input type="number" step="0.01" id="total-macros-kcal" name="total-macros-kcal" placeholder="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-macros-percent">Total dos Macros (%):</label>
                        <input type="text" id="total-macros-percent" name="total-macros-percent" placeholder="0.00%" readonly>
                    </div>
                    <div class="form-group">
                        <label for="vct">VCT (Kcal):</label>
                        <input type="number" step="0.01" id="vct" name="vct" placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </section>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar Ficha T√©cnica</button>
        </div>
    </form>
</div>

<script>
    // Fun√ß√£o para buscar ingredientes do backend para autocomplete
    async function buscarIngredientes(query) {
        console.log(`[DEBUG - API] Buscando ingredientes para a query: "${query}"`);
        try {
            const response = await fetch(`/api/ingredientes/buscar?nome=${encodeURIComponent(query)}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                console.log("[DEBUG - API] Resposta da API de ingredientes:", data);
                return data;
            } else if (response.status === 401 || response.status === 403) {
                alert('Sua sess√£o expirou ou voc√™ n√£o est√° autorizado. Fa√ßa login novamente.');
                window.location.href = '/login';
                return [];
            } else {
                const errorText = await response.text();
                console.error('[DEBUG - API] Erro ao buscar ingredientes:', response.status, response.statusText, errorText);
                alert('Erro ao buscar ingredientes: ' + (errorText || response.statusText));
                return [];
            }
        } catch (error) {
            console.error('[DEBUG - API] Erro na requisi√ß√£o de buscar ingredientes:', error);
            alert('Ocorreu um erro na comunica√ß√£o com o servidor.');
            return [];
        }
    }

    // Fun√ß√£o para adicionar uma nova linha na tabela de ingredientes
    function adicionarIngrediente(ingredienteData = null) {
        console.log("[DEBUG - UI] Adicionando nova linha de ingrediente.");
        const tableBody = document.querySelector('#ingredientes-table tbody');
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="ingrediente-nome" placeholder="Ingrediente"></td>
            <td><input type="text" class="medida-caseira-ingrediente" placeholder="Medida"></td>
            <td><input type="number" step="0.01" class="pb-ingrediente" placeholder="0.00"></td>
            <td><input type="number" step="0.01" class="pl-ingrediente" placeholder="0.00"></td>
            <td><input type="number" step="0.01" class="fc-ingrediente" placeholder="0.00" readonly></td>
            <td><input type="number" step="0.01" class="custo-compra-ingrediente" placeholder="R$ 0,00"></td>
            <td><input type="number" step="0.01" class="custo-utilizado-ingrediente" placeholder="R$ 0,00" readonly></td>
            <td><button type="button" class="btn-remover" onclick="removerLinha(this)">Remover</button></td>
        `;

        const ingredienteNomeInput = newRow.querySelector('.ingrediente-nome');
        const medidaCaseiraInput = newRow.querySelector('.medida-caseira-ingrediente');
        const pbInput = newRow.querySelector('.pb-ingrediente');
        const plInput = newRow.querySelector('.pl-ingrediente');
        const fcInput = newRow.querySelector('.fc-ingrediente');
        const custoCompraInput = newRow.querySelector('.custo-compra-ingrediente');
        const custoUtilizadoInput = newRow.querySelector('.custo-utilizado-ingrediente');

        // Se dados de ingrediente forem fornecidos (quando carregando do banco ou do autocomplete)
        if (ingredienteData) {
            ingredienteNomeInput.value = ingredienteData.ingredienteNome || '';
            ingredienteNomeInput.dataset.ingredienteId = ingredienteData.ingredienteId; // Salva o ID
            medidaCaseiraInput.value = ingredienteData.medidaCaseira || '';
            pbInput.value = (ingredienteData.pesoBruto || 0).toFixed(2);
            plInput.value = (ingredienteData.pesoLiquido || 0).toFixed(2);
            fcInput.value = (ingredienteData.fatorCorrecao || 0).toFixed(2);
            custoCompraInput.value = (ingredienteData.custoCompra || 0).toFixed(2);
            custoUtilizadoInput.value = (ingredienteData.custoUtilizado || 0).toFixed(2);

            // Armazenar dados nutricionais no dataset da linha para c√°lculos
            newRow.dataset.proteina = ingredienteData.proteina || 0;
            newRow.dataset.carboidrato = ingredienteData.carboidrato || 0;
            newRow.dataset.lipidio = ingredienteData.lipidio || 0;
            newRow.dataset.sodio = ingredienteData.sodio || 0;
            newRow.dataset.gorduraSaturada = ingredienteData.gorduraSaturada || 0;
            newRow.dataset.kcal = (ingredienteData.proteina * 4) + (ingredienteData.carboidrato * 4) + (ingredienteData.lipidio * 9);

            console.log("[DEBUG - LOAD] Ingrediente carregado/preenchido, dados na linha (tr.dataset):", newRow.dataset);
        }

        setupAutocompleteForElement(ingredienteNomeInput);

        pbInput.addEventListener('input', atualizarCalculosIngrediente);
        plInput.addEventListener('input', atualizarCalculosIngrediente);
        custoCompraInput.addEventListener('input', atualizarCalculosIngrediente);

        // Se n√£o for uma carga de dados (ou seja, √© uma adi√ß√£o manual de linha),
        // chamamos atualizarCalculosGlobais. Se for uma carga, ser√° chamado no final da carga.
        if (!ingredienteData) {
            atualizarCalculosGlobais();
        }
    }

    // Fun√ß√£o para adicionar uma nova linha na tabela nutricional (exemplo)
    function adicionarNutriente() {
        console.log("[DEBUG - UI] adicionarNutriente() chamada. (Esta fun√ß√£o √© para demonstra√ß√£o, n√£o autom√°tica)");
        const tableBody = document.querySelector('#nutricional-table tbody');
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" placeholder="Ingrediente"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><input type="number" step="0.01" placeholder="0.00"></td>
            <td><button type="button" class="btn-remover" onclick="removerLinha(this)">Remover</button></td>
        `;
    }

    function removerLinha(button) {
        console.log("[DEBUG - UI] Removendo linha.");
        const row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
        atualizarCalculosGlobais();
    }

    async function setupAutocompleteForElement(inputElement) {
        let timeout = null;
        inputElement.addEventListener('input', async function(e) {
            clearTimeout(timeout);
            const query = e.target.value;

            // Limpa o ID do ingrediente e os dados nutricionais associados √† linha
            e.target.dataset.ingredienteId = '';
            const currentRow = e.target.closest('tr');
            if (currentRow) {
                currentRow.dataset.proteina = '';
                currentRow.dataset.carboidrato = '';
                currentRow.dataset.lipidio = '';
                currentRow.dataset.sodio = '';
                currentRow.dataset.gorduraSaturada = '';
                currentRow.dataset.kcal = '';
                // Limpar o PL e PB tamb√©m ao come√ßar a digitar um novo ingrediente
                // N√£o zera custoCompra para que o usu√°rio n√£o perca o valor j√° digitado.
                currentRow.querySelector('.pb-ingrediente').value = '0.00';
                currentRow.querySelector('.pl-ingrediente').value = '0.00';
                currentRow.querySelector('.fc-ingrediente').value = '0.00';
                currentRow.querySelector('.custo-utilizado-ingrediente').value = '0.00';
            }

            let old = inputElement.parentNode.querySelector('.autocomplete-list');
            if (old) old.remove();

            if (query.length < 2) return;

            timeout = setTimeout(async () => {
                const lista = await buscarIngredientes(query);

                if (lista.length > 0) {
                    let dropdown = document.createElement('div');
                    dropdown.className = 'autocomplete-list';
                    dropdown.style.position = 'absolute';
                    dropdown.style.background = '#fff';
                    dropdown.style.border = '1px solid #ccc';
                    dropdown.style.zIndex = 1000;
                    dropdown.style.maxHeight = '200px';
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.width = inputElement.offsetWidth + 'px';

                    lista.forEach(item => {
                        let option = document.createElement('div');
                        option.textContent = item.nome;
                        option.dataset.ingredienteId = item.id;
                        // Armazena todos os dados nutricionais no dataset do option
                        option.dataset.proteina = item.proteina;
                        option.dataset.carboidrato = item.carboidrato;
                        option.dataset.lipidio = item.lipidio;
                        option.dataset.sodio = item.sodio;
                        option.dataset.gorduraSaturada = item.gorduraSaturada;
                        option.dataset.kcal = (item.proteina * 4) + (item.carboidrato * 4) + (item.lipidio * 9); // Calcula Kcal por 100g

                        option.onclick = () => {
                            e.target.value = item.nome;
                            e.target.dataset.ingredienteId = item.id;

                            const tr = e.target.closest('tr');
                            const plInput = tr.querySelector('.pl-ingrediente');
                            const pbInput = tr.querySelector('.pb-ingrediente');
                            const fcInput = tr.querySelector('.fc-ingrediente');
                            const custoUtilizadoInput = tr.querySelector('.custo-utilizado-ingrediente');
                            const custoCompraInput = tr.querySelector('.custo-compra-ingrediente');

                            tr.dataset.ingredienteId = item.id;
                            tr.dataset.proteina = item.proteina;
                            tr.dataset.carboidrato = item.carboidrato;
                            tr.dataset.lipidio = item.lipidio;
                            tr.dataset.sodio = item.sodio;
                            tr.dataset.gorduraSaturada = item.gorduraSaturada;
                            tr.dataset.kcal = option.dataset.kcal;

                            const defaultPl = 100; // Define um PL padr√£o de 100g
                            plInput.value = defaultPl.toFixed(2);
                            pbInput.value = defaultPl.toFixed(2); // Pode ser igual ao PL para come√ßar (FC = 1)
                            fcInput.value = (1).toFixed(2); // FC inicial = 1 se PL=PB

                            const custoCompra = parseFloat(custoCompraInput.value) || 0;
                            const custoUtilizado = (defaultPl > 0) ? (custoCompra * (defaultPl / defaultPl)) : 0; // Se PL=PB, custoUtilizado = custoCompra
                            custoUtilizadoInput.value = custoUtilizado.toFixed(2);


                            console.log("[DEBUG - AUTOC] Item selecionado do autocomplete. Dados na linha (tr.dataset):", tr.dataset);
                            console.log(`[DEBUG - AUTOC] PL e PB definidos para ${defaultPl}g. Recalculando.`);
                            dropdown.remove();
                            atualizarCalculosGlobais();
                        };
                        dropdown.appendChild(option);
                    });
                    inputElement.parentNode.appendChild(dropdown);
                }
            }, 300);
        });

        inputElement.addEventListener('blur', function() {
            setTimeout(() => {
                let old = inputElement.parentNode.querySelector('.autocomplete-list');
                if (old) old.remove();
            }, 100);
        });
    }

    async function carregarFichaTecnicaExistente(fichaTecnicaId) {
        console.log(`[DEBUG - LOAD] Tentando carregar ficha t√©cnica com ID: ${fichaTecnicaId}`);
        try {
            const response = await fetch(`/api/receitas/${fichaTecnicaId}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const fichaTecnica = await response.json();
                console.log("[DEBUG - LOAD] Ficha T√©cnica carregada:", fichaTecnica);

                document.getElementById('nome-preparacao').value = fichaTecnica.nome || '';
                document.getElementById('categoria').value = fichaTecnica.categoria || '';
                document.getElementById('numero').value = fichaTecnica.numero || '';
                document.getElementById('modo-preparo').value = fichaTecnica.modoPreparo || '';
                document.getElementById('equipamentos').value = fichaTecnica.equipamentos || '';
                document.getElementById('tempo-preparo').value = fichaTecnica.tempoPreparo || '';
                document.getElementById('medida-caseira').value = fichaTecnica.medidaCaseira || '';
                document.getElementById('peso-porcao').value = (fichaTecnica.pesoPorcao || 0).toFixed(2);
                document.getElementById('numero-porcoes').value = fichaTecnica.numeroPorcoes || '';
                document.getElementById('agua-fcc').value = fichaTecnica.aguaFcc || '0.00';
                document.getElementById('fcc').value = (fichaTecnica.fcc || 0).toFixed(2);

                const tableBody = document.querySelector('#ingredientes-table tbody');
                tableBody.innerHTML = '';

                if (fichaTecnica.ingredientes && fichaTecnica.ingredientes.length > 0) {
                    fichaTecnica.ingredientes.forEach(ingrediente => {
                        adicionarIngrediente(ingrediente);
                    });
                } else {
                    adicionarIngrediente();
                }

                if (fichaTecnica.perfilNutricional) {
                    document.getElementById('total-macros-g').value = (fichaTecnica.perfilNutricional.totalGramas || 0).toFixed(2);
                    document.getElementById('total-macros-kcal').value = (fichaTecnica.perfilNutricional.totalKcal || 0).toFixed(2);
                    document.getElementById('total-macros-percent').value = (fichaTecnica.perfilNutricional.totalPorcentagem || 0).toFixed(2) + '%';
                    document.getElementById('vct').value = (fichaTecnica.perfilNutricional.vct || 0).toFixed(2);
                    document.getElementById('custo-total').value = (fichaTecnica.custoTotal || 0).toFixed(2);
                    document.getElementById('custo-per-capita').value = (fichaTecnica.custoPerCapita || 0).toFixed(2);
                    document.getElementById('rendimento').value = (fichaTecnica.rendimento || 0).toFixed(2);
                }

                atualizarCalculosGlobais();

            } else if (response.status === 404) {
                console.warn(`[DEBUG - LOAD] Ficha T√©cnica com ID ${fichaTecnicaId} n√£o encontrada. Criando nova ficha.`);
                adicionarIngrediente();
                atualizarCalculosGlobais();
            } else if (response.status === 401 || response.status === 403) {
                alert('Sua sess√£o expirou ou voc√™ n√£o est√° autorizado. Fa√ßa login novamente.');
                window.location.href = '/login';
            } else {
                const errorText = await response.text();
                console.error(`[DEBUG - LOAD] Erro ao carregar ficha t√©cnica ${fichaTecnicaId}:`, response.status, response.statusText, errorText);
                alert('Erro ao carregar ficha t√©cnica: ' + (errorText || response.statusText));
                adicionarIngrediente();
                atualizarCalculosGlobais();
            }
        } catch (error) {
            console.error('[DEBUG - LOAD] Erro na requisi√ß√£o para carregar ficha t√©cnica:', error);
            alert('Ocorreu um erro na comunica√ß√£o com o servidor ao carregar a ficha t√©cnica.');
            adicionarIngrediente();
            atualizarCalculosGlobais();
        }
    }


    function coletarDadosFormulario() {
        console.log("[DEBUG - SUBMIT] Coletando dados do formul√°rio para envio.");
        const dados = {
            nome: document.getElementById('nome-preparacao').value,
            categoria: document.getElementById('categoria').value,
            modoPreparo: document.getElementById('modo-preparo').value,
            tempoPreparo: parseFloat(document.getElementById('tempo-preparo').value) || 0,
            pesoPorcao: parseFloat(document.getElementById('peso-porcao').value) || 0.0,
            rendimento: parseFloat(document.getElementById('rendimento').value) || 0.0,
            numeroPorcoes: parseInt(document.getElementById('numero-porcoes').value) || 0,
            fcc: parseFloat(document.getElementById('fcc').value) || 0.0,
            medidaCaseira: document.getElementById('medida-caseira').value,
            equipamentos: document.getElementById('equipamentos').value,
        };

        const ingredientes = [];
        document.querySelectorAll('#ingredientes-table tbody tr').forEach(row => {
            const ingredienteNomeInput = row.querySelector('.ingrediente-nome');
            const ingredienteId = ingredienteNomeInput.dataset.ingredienteId;

            if (ingredienteId && ingredienteNomeInput.value.trim() !== '') {
                ingredientes.push({
                    ingredienteId: parseInt(ingredienteId),
                    ingredienteNome: ingredienteNomeInput.value.trim(),
                    medidaCaseira: row.querySelector('.medida-caseira-ingrediente').value,
                    pesoBruto: parseFloat(row.querySelector('.pb-ingrediente').value) || 0.0,
                    pesoLiquido: parseFloat(row.querySelector('.pl-ingrediente').value) || 0.0,
                    fatorCorrecao: parseFloat(row.querySelector('.fc-ingrediente').value) || 0.0,
                    custoCompra: parseFloat(row.querySelector('.custo-compra-ingrediente').value) || 0.0,
                    custoUtilizado: parseFloat(row.querySelector('.custo-utilizado-ingrediente').value) || 0.0,
                });
            } else {
                console.warn(`[DEBUG - SUBMIT] Ingrediente ignorado por falta de nome ou ID: ${ingredienteNomeInput.value}, ID: ${ingredienteId}`);
            }
        });
        dados.ingredientes = ingredientes;

        const perfilNutricional = {
            perCapita: parseFloat(document.getElementById('peso-porcao').value) || 0.0,
            totalGramas: parseFloat(document.getElementById('total-macros-g').value) || 0.0,
            totalKcal: parseFloat(document.getElementById('total-macros-kcal').value) || 0.0,
            totalPorcentagem: parseFloat(document.getElementById('total-macros-percent').value.replace('%', '')) || 0.0,
            vct: parseFloat(document.getElementById('vct').value) || 0.0
        };

        dados.custoTotal = parseFloat(document.getElementById('custo-total').value) || 0.0;
        dados.custoPerCapita = parseFloat(document.getElementById('custo-per-capita').value) || 0.0;
        dados.rendimento = parseFloat(document.getElementById('rendimento').value) || 0.0;


        if (perfilNutricional.totalKcal > 0 || perfilNutricional.totalGramas > 0 || perfilNutricional.vct > 0) {
            dados.perfilNutricional = perfilNutricional;
        } else {
            dados.perfilNutricional = null;
        }

        return dados;
    }

    document.getElementById('fichaTecnicaForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const dadosParaEnviar = coletarDadosFormulario();
        console.log("[DEBUG - SUBMIT] Dados a serem enviados:", dadosParaEnviar);

        const urlParams = new URLSearchParams(window.location.search);
        const fichaTecnicaId = urlParams.get('id');
        const method = fichaTecnicaId ? 'PUT' : 'POST';
        const url = fichaTecnicaId ? `/api/receitas/${fichaTecnicaId}` : '/api/receitas';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosParaEnviar),
                credentials: 'include'
            });

            if (response.ok) {
                alert('Ficha T√©cnica salva com sucesso!');
                const responseData = await response.json();
                window.location.href = `/visualizar?id=${responseData.id}`;
            } else if (response.status === 401 || response.status === 403) {
                alert('Sua sess√£o expirou ou voc√™ n√£o est√° autorizado. Fa√ßa login novamente.');
                window.location.href = '/login';
            } else {
                const errorData = await response.json();
                console.error('[DEBUG - SUBMIT] Erro ao salvar ficha t√©cnica:', errorData);
                alert('Erro ao salvar ficha t√©cnica: ' + (errorData.message || response.statusText));
            }
        } catch (error) {
            console.error('[DEBUG - SUBMIT] Erro na requisi√ß√£o:', error);
            alert('Ocorreu um erro na comunica√ß√£o com o servidor.');
        }
    });

    document.querySelectorAll('.pb-ingrediente, .pl-ingrediente, .custo-compra-ingrediente').forEach(input => {
        input.addEventListener('input', atualizarCalculosIngrediente);
    });

    function atualizarCalculosIngrediente(event) {
        console.log("[DEBUG - CALC] Evento 'input' disparado para c√°lculo de ingrediente.");
        const row = event.target.closest('tr');
        const pb = parseFloat(row.querySelector('.pb-ingrediente').value) || 0;
        const pl = parseFloat(row.querySelector('.pl-ingrediente').value) || 0;
        const custoCompra = parseFloat(row.querySelector('.custo-compra-ingrediente').value) || 0;

        const fc = (pb > 0 && pl > 0) ? (pb / pl) : 0;
        row.querySelector('.fc-ingrediente').value = fc.toFixed(2);

        const custoUtilizado = (pb > 0) ? (custoCompra * (pl / pb)) : 0;
        row.querySelector('.custo-utilizado-ingrediente').value = custoUtilizado.toFixed(2);

        atualizarCalculosGlobais();
    }

    // Fun√ß√£o para atualizar c√°lculos globais (Custo Total, Custo Per Capita, FCC Geral, Totais Nutricionais)
    function atualizarCalculosGlobais() {
        console.log("[DEBUG - CALC] Iniciando atualiza√ß√£o de c√°lculos globais.");
        let custoTotal = 0;
        let totalPesoLiquido = 0;
        let totalPesoBruto = 0;
        let totalProteina = 0;
        let totalCarboidrato = 0;
        let totalLipidio = 0;
        let totalSodio = 0;
        let totalGorduraSaturada = 0;
        let totalKcal = 0;

        // Clear the existing rows in the nutritional table
        const nutricionalTableBody = document.querySelector('#nutricional-table tbody');
        nutricionalTableBody.innerHTML = '';

        document.querySelectorAll('#ingredientes-table tbody tr').forEach((row, index) => {
            console.log(`[DEBUG - CALC] Processando linha de ingrediente ${index + 1}:`, row.dataset);

            const ingredienteNome = row.querySelector('.ingrediente-nome')?.value || 'Desconhecido';
            const custoUtilizado = parseFloat(row.querySelector('.custo-utilizado-ingrediente')?.value) || 0;
            const pl = parseFloat(row.querySelector('.pl-ingrediente')?.value) || 0;
            const pb = parseFloat(row.querySelector('.pb-ingrediente')?.value) || 0;

            custoTotal += custoUtilizado;
            totalPesoLiquido += pl;
            totalPesoBruto += pb;

            const proteinaBase = parseFloat(row.dataset.proteina) || 0;
            const carboidratoBase = parseFloat(row.dataset.carboidrato) || 0;
            const lipidioBase = parseFloat(row.dataset.lipidio) || 0;
            const sodioBase = parseFloat(row.dataset.sodio) || 0;
            const gorduraSaturadaBase = parseFloat(row.dataset.gorduraSaturada) || 0;
            const kcalBase = parseFloat(row.dataset.kcal) || 0; // Kcal por 100g

            console.log(`[DEBUG - CALC] Ingrediente ${index + 1} - PL: ${pl}, PTN_Base: ${proteinaBase}, CHO_Base: ${carboidratoBase}, LIP_Base: ${lipidioBase}, Kcal/100g: ${kcalBase}`);

            let proteinaProporcional = 0;
            let carboidratoProporcional = 0;
            let lipidioProporcional = 0;
            let sodioProporcional = 0;
            let gorduraSaturadaProporcional = 0;
            let kcalProporcional = 0;

            if (pl > 0) {
                const fatorProporcional = pl / 100;
                proteinaProporcional = proteinaBase * fatorProporcional;
                carboidratoProporcional = carboidratoBase * fatorProporcional;
                lipidioProporcional = lipidioBase * fatorProporcional;
                sodioProporcional = sodioBase * fatorProporcional;
                gorduraSaturadaProporcional = gorduraSaturadaBase * fatorProporcional;
                kcalProporcional = kcalBase * fatorProporcional; // Kcal para o PL usado
            }

            totalProteina += proteinaProporcional;
            totalCarboidrato += carboidratoProporcional;
            totalLipidio += lipidioProporcional;
            totalSodio += sodioProporcional;
            totalGorduraSaturada += gorduraSaturadaProporcional;
            totalKcal += kcalProporcional;

            // Add row to the Perfil Nutricional table
            const newNutriRow = nutricionalTableBody.insertRow();
            newNutriRow.innerHTML = `
                <td>${ingredienteNome}</td>
                <td>${pl.toFixed(2)}</td>
                <td>${proteinaProporcional.toFixed(2)}</td>
                <td>${carboidratoProporcional.toFixed(2)}</td>
                <td>${lipidioProporcional.toFixed(2)}</td>
                <td>${sodioProporcional.toFixed(2)}</td>
                <td>${gorduraSaturadaProporcional.toFixed(2)}</td>
                <td></td> `;
        });

        console.log("[DEBUG - CALC] Totais brutos antes de exibir:", {
            totalProteina: totalProteina.toFixed(2),
            totalCarboidrato: totalCarboidrato.toFixed(2),
            totalLipidio: totalLipidio.toFixed(2),
            totalSodio: totalSodio.toFixed(2),
            totalGorduraSaturada: totalGorduraSaturada.toFixed(2),
            totalKcal: totalKcal.toFixed(2),
            custoTotal: custoTotal.toFixed(2),
            totalPesoLiquido: totalPesoLiquido.toFixed(2),
            totalPesoBruto: totalPesoBruto.toFixed(2)
        });

        const aguaFccSelect = document.getElementById('agua-fcc');
        const percentualDeAguaAdicionada = parseFloat(aguaFccSelect.value) || 0;

        let pesoLiquidoFinalDaPreparacao = totalPesoLiquido * (1 + percentualDeAguaAdicionada);

        const fccGeral = (totalPesoBruto > 0 && pesoLiquidoFinalDaPreparacao > 0) ? (totalPesoBruto / pesoLiquidoFinalDaPreparacao) : 0;
        document.getElementById('fcc').value = fccGeral.toFixed(2);

        document.getElementById('custo-total').value = custoTotal.toFixed(2);

        const numeroPorcoes = parseInt(document.getElementById('numero-porcoes').value) || 1;
        const custoPerCapita = numeroPorcoes > 0 ? (custoTotal / numeroPorcoes) : 0;
        document.getElementById('custo-per-capita').value = custoPerCapita.toFixed(2);

        // Atualizar totais nutricionais
        document.getElementById('total-macros-g').value = (totalProteina + totalCarboidrato + totalLipidio).toFixed(2);
        document.getElementById('total-macros-kcal').value = totalKcal.toFixed(2);

        document.getElementById('vct').value = totalKcal.toFixed(2);

        let totalMacrosPercent = "0.00%";
        if (totalKcal > 0) {
            const percentCHO = (totalCarboidrato * 4 / totalKcal * 100);
            const percentPTN = (totalProteina * 4 / totalKcal * 100);
            const percentLIP = (totalLipidio * 9 / totalKcal * 100);
            totalMacrosPercent = `${(percentPTN + percentCHO + percentLIP).toFixed(2)}%`;
        }
        document.getElementById('total-macros-percent').value = totalMacrosPercent;

        document.getElementById('rendimento').value = pesoLiquidoFinalDaPreparacao.toFixed(2);

        const pesoPorcaoInput = document.getElementById('peso-porcao');
        const numeroPorcoesInput = document.getElementById('numero-porcoes');

        if (pesoPorcaoInput && parseFloat(pesoPorcaoInput.value) > 0 && pesoLiquidoFinalDaPreparacao > 0) {
            numeroPorcoesInput.value = Math.floor(pesoLiquidoFinalDaPreparacao / parseFloat(pesoPorcaoInput.value));
        } else if (numeroPorcoesInput && parseInt(numeroPorcoesInput.value) > 0 && pesoLiquidoFinalDaPreparacao > 0) {
            pesoPorcaoInput.value = (pesoLiquidoFinalDaPreparacao / parseInt(numeroPorcoesInput.value)).toFixed(2);
        } else {
            pesoPorcaoInput.value = '0.00';
            numeroPorcoesInput.value = '0';
        }
        console.log("[DEBUG - CALC] C√°lculos globais atualizados. Valores exibidos no formul√°rio.");
    }

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const fichaTecnicaId = urlParams.get('id');

        if (fichaTecnicaId) {
            carregarFichaTecnicaExistente(fichaTecnicaId);
        } else {
            adicionarIngrediente();
            atualizarCalculosGlobais();
        }

        document.querySelectorAll('.ingrediente-nome').forEach(input => {
            setupAutocompleteForElement(input);
        });

        document.querySelectorAll('.pb-ingrediente, .pl-ingrediente, .custo-compra-ingrediente').forEach(input => {
            input.addEventListener('input', atualizarCalculosIngrediente);
        });

        document.getElementById('numero-porcoes').addEventListener('input', atualizarCalculosGlobais);
        document.getElementById('peso-porcao').addEventListener('input', atualizarCalculosGlobais);
        document.getElementById('agua-fcc').addEventListener('change', atualizarCalculosGlobais);
    });
</script>
</body>
</html>